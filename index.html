<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="Platform AI">
  <title>Platform GPT</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css" rel="stylesheet" />
  <link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/platformaivn/web@1.0.68/dist/img/logo_icon.png"
    type="image/x-icon" />
  <link rel="stylesheet" href="/cdn/15/css/style-v1.0.10.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.0/themes/prism.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/2.1.3/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.0/prism.min.js"></script>
</head>

<body>
  <!-- Header -->
  <header class="main-header">
    <div class="header-container">
      <div class="logo-container">
        <img src="https://cdn.jsdelivr.net/gh/platformaivn/web@1.0.68/dist/img/logo_icon.png" alt="Platform AI Logo"
          class="logo">
        <h1 class="brand-name">Platform AI</h1>
      </div>
      <div class="header-actions">
        <button id="user-info-button" class="header-button">
          <i class="fas fa-user"></i> Loading...
        </button>
        <button class="header-button">
          <i class="fas fa-cog"></i> Settings
        </button>
      </div>
    </div>
  </header>
  <!-- Main container -->
  <div class="container-fluid">
    <div class="row">
      <!-- Side navigation -->
      <div class="side-nav col-lg-3 col-md-12">
        <!-- New AI Tool button -->
        <div class="row p-2">
          <div class="chat-btn d-flex align-items-center">
            <span class="d-block">+ New AI Tool</span>
          </div>
        </div>

        <!-- Chat history -->
        <div class="row p-2">
          <ul class="list-unstyled">
            <div class="chat-history">
              <!-- Old chats will be displayed here -->
            </div>
          </ul>
        </div>

        <!-- Model selection and parameters -->
        <!-- START MODELS -->
        <div class="row p-2">
          <label for="gpt-model" class="form-label">Model</label>
          <select name="gpt-model" id="gpt-model" class="form-select text-light gpt-model">
            <option value="openai/gpt-4o-mini-2024-07-18:openrouter">gpt-4o-mini</option>
          </select>
        </div>


        <!-- START TEMPERATURE -->
        <div class="row p-2">
          <div class="col-12">
            <p class="form-label">Temperature</p>
          </div>
          <div class="col-10">
            <input type="range" class="form-range w-100" min="0" max="1" step="0.1" id="gpt-temperature"
              name="gpt-temperature" value="0" />
          </div>
          <div class="col-2 text-end">
            <output for="gpt-temperature">0</output>
          </div>
        </div>

        <!-- START MAXIMUM LENGTH -->
        <div class="row p-2">
          <div class="col-12">
            <p class="form-label">Maximum Length</p>
          </div>
          <div class="col-10">
            <input type="range" class="form-range w-100" min="0" max="16384" step="8" id="gpt-max-len"
              name="gpt-max-len" value="2048" />
          </div>
          <div class="col-2 text-end">
            <output for="gpt-max-len">2048</output>
          </div>
        </div>

        <!-- START TOP P -->
        <div class="row p-2">
          <div class="col-12">
            <p class="form-label">TopP</p>
          </div>
          <div class="col-10">
            <input type="range" class="form-range w-100" min="0" max="1" step="0.01" id="gpt-topP" name="gpt-topP"
              value="0.07" />
          </div>
          <div class="col-2 text-end">
            <output for="gpt-topP">0.07</output>
          </div>
        </div>

        <!-- START FREQUENCY PENALTY -->
        <div class="row p-2">
          <div class="col-12">
            <p class="form-label">Frequency Penalty</p>
          </div>
          <div class="col-10">
            <input type="range" class="form-range w-100" min="0" max="2" step="0.01" id="gpt-frequency"
              name="gpt-frequency" value="1" />
          </div>
          <div class="col-2 text-end">
            <output for="gpt-frequency">1</output>
          </div>
        </div>

        <!-- START PRESENCE PENALTY -->
        <div class="row p-2">
          <div class="col-12">
            <p class="form-label">Presence Penalty</p>
          </div>
          <div class="col-10">
            <input type="range" class="form-range w-100" min="0" max="2" step="0.01" id="gpt-precence"
              name="gpt-precence" value="0.5" />
          </div>
          <div class="col-2 text-end">
            <output for="gpt-precence">0.5</output>
          </div>
        </div>

        <!-- START HISTORY LIMIT -->
        <div class="row p-2">
          <div class="col-12">
            <p class="form-label">History Limit</p>
          </div>
          <div class="col-10">
            <input type="range" class="form-range w-100" min="1" max="50" step="1" id="gpt-history-limit"
              name="gpt-history-limit" value="10" />
          </div>
          <div class="col-2 text-end">
            <output for="gpt-history-limit">10</output>
          </div>
        </div>


        <!-- Add System Prompt textarea -->
        <div class="row p-2">
          <label for="system-prompt" class="form-label">System Prompt</label>
          <div class="col-12 system-prompt-inputs-container d-flex align-items-center">
            <textarea id="system-prompt" class="form-control" rows="8"
              placeholder="Enter system prompt here"></textarea>
          </div>
        </div>

        <hr />

        <!-- Settings, Help, and Logout links -->
        <div class="row">
          <div class="col-12">
            <ul class="list-unstyled">
              <li class="nav-item">
                <a class="nav-link text-white" href="#">
                  <i class="fas fa-cog"></i> Settings
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link text-white" href="#">
                  <i class="fas fa-question-circle"></i> Get Help
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link text-white" href="#" id="logout-button">
                  <i class="fas fa-sign-out-alt"></i> Log Out
                </a>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Chat content -->
      <div class="content p-0 pt-2 col-lg-9 col-md-12">
        <div class="chat-content-area" id="chat-content-area">
          <div id="welcome-screen" class="h-100 flex-column align-items-center justify-content-center text-center p-4">
            <img src="https://cdn.jsdelivr.net/gh/platformaivn/web@1.0.68/dist/img/logo_icon.png" alt="Platform AI Logo"
              class="welcome-logo mb-4">
            <h2 class="text-light mb-2">Welcome to Platform AI</h2>
            <p>Start a conversation to begin</p>
          </div>
        </div>

        <!-- Chat input area -->
        <div class="chat-input-area overflow-hidden">
          <div class="row">
            <div class="col-12 chat-inputs-area-inner">
              <div class="preview-container" id="image-preview-container"></div>
              <div class="row chat-inputs-container d-flex align-items-center">
                <textarea id="chat-input" class="col-10" placeholder="Send a message"></textarea>
                <span class="col-1">
                  <div class="upload-btn-wrapper">
                    <i class="fas fa-image" style="cursor: pointer;"></i>
                    <input type="file" style="width: 20px;" id="image-upload" accept="image/*" multiple />
                  </div>
                </span>
                <span class="col-1" id="send-button">
                  <i class="fa fa-paper-plane" aria-hidden="true" style="cursor: pointer;"></i>
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="d-flex align-items-center justify-content-center position-relative bottom-0">
    <div class="text-center">Â© 2024 Copyright Platform AI</div>
  </footer>
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Login to Platform AI</h2>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="username">Username:</label>
          <input type="text" id="username" class="form-control" placeholder="Enter username">
        </div>
        <div class="form-group">
          <label for="password">Password:</label>
          <input type="password" id="password" class="form-control" placeholder="Enter password">
        </div>
        <div id="loginError" class="alert alert-danger" style="display: none;"></div>
        <button id="loginButton" class="btn btn-primary">
          Login
          <div class="spinner"></div>
        </button>
      </div>
    </div>
  </div>
  <!-- External JS resources -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/material-ui/5.0.0-beta.5/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/cdn/15/js/storage.js"></script>

  <script>
    const apiKey = '{{ apiKey }}'; // Replace with your OpenAI API key
    const chatHistory = [];
    let currentChat = "";
    let selectedChat;
    let selectedFiles = [];
    function checkAuth() {
      const accessToken = getCookie('access_token');
      if (!accessToken) {
        logout(); // Call logout instead of just showing login modal
        return false;
      }
      return true;
    }

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }

    function setCookie(name, value, days) {
      const date = new Date();
      date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
      const expires = `expires=${date.toUTCString()}`;
      document.cookie = `${name}=${value};${expires};path=/`;
    }

    function showLoginModal() {
      const modal = document.getElementById('loginModal');
      modal.classList.add('force-show');
    }

    function hideLoginModal() {
      const modal = document.getElementById('loginModal');
      if (getCookie('access_token')) {
        loadChatHistoryFromStorage();
        modal.classList.remove('force-show');
      }
    }

    async function login(username, password) {
      const loginButton = document.getElementById('loginButton');
      const errorDiv = document.getElementById('loginError');

      try {
        loginButton.disabled = true;
        loginButton.classList.add('loading');
        errorDiv.style.display = 'none';

        const formData = new URLSearchParams();
        formData.append('username', username);
        formData.append('password', password);

        const response = await fetch('https://api.platform.ai.vn/services/platform-ai-api/auth/token', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'accept': 'application/json'
          },
          body: formData
        });

        if (!response.ok) {
          throw new Error('Login failed');
        }

        const data = await response.json();
        setCookie('access_token', data.access_token, 7);
        hideLoginModal();
        return true;
      } catch (error) {
        console.error('Login error:', error);
        errorDiv.textContent = 'Invalid username or password';
        errorDiv.style.display = 'block';
        return false;
      } finally {
        loginButton.disabled = false;
        loginButton.classList.remove('loading');
      }
    }
    // Function to check if the number of code blocks is odd or even
    function isOddCodeBlocks(str) {
      return (str.split('```').length - 1) % 2 !== 0;
    }

    // Function to convert file to base64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
      });
    }

    // Function to get current parameter values
    function getCurrentConfig() {
      return {
        model: document.getElementById('gpt-model').value,
        temperature: parseFloat(document.getElementById('gpt-temperature').value),
        max_tokens: parseInt(document.getElementById('gpt-max-len').value),
        top_p: parseFloat(document.getElementById('gpt-topP').value),
        frequency_penalty: parseFloat(document.getElementById('gpt-frequency').value),
        presence_penalty: parseFloat(document.getElementById('gpt-precence').value),
        history_limit: parseInt(document.getElementById('gpt-history-limit').value),
        system_prompt: document.getElementById('system-prompt').value
      };
    }

    // Function to apply config to UI
    function applyConfig(config) {
      document.getElementById('gpt-model').value = config.model;
      document.getElementById('gpt-temperature').value = config.temperature;
      document.getElementById('gpt-max-len').value = config.max_tokens;
      document.getElementById('gpt-topP').value = config.top_p;
      document.getElementById('gpt-frequency').value = config.frequency_penalty;
      document.getElementById('gpt-precence').value = config.presence_penalty;
      document.getElementById('gpt-history-limit').value = config.history_limit;
      document.getElementById('system-prompt').value = config.system_prompt;

      // Update all range input displays
      document.querySelectorAll('input[type="range"]').forEach(updateOutput);
    }

    // Default configuration
    const defaultConfig = {
      model: "openai/gpt-4o-mini-2024-07-18:openrouter",
      temperature: 0,
      max_tokens: 2048,
      top_p: 0.07,
      frequency_penalty: 1,
      presence_penalty: 0.5,
      history_limit: 10,
      system_prompt: ""
    };


    // Function to update image preview
    function updateImagePreview() {
      const container = document.getElementById('image-preview-container');
      container.innerHTML = '';

      selectedFiles.forEach((file, index) => {
        const previewItem = document.createElement('div');
        previewItem.className = 'preview-item';

        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);

        const removeBtn = document.createElement('div');
        removeBtn.className = 'remove-image';
        removeBtn.innerHTML = 'Ã';
        removeBtn.onclick = () => {
          selectedFiles = selectedFiles.filter((_, i) => i !== index);
          updateImagePreview();
        };

        previewItem.appendChild(img);
        previewItem.appendChild(removeBtn);
        container.appendChild(previewItem);
      });
    }

    // Handle image upload
    document.getElementById('image-upload').addEventListener('change', function (event) {
      const files = Array.from(event.target.files);
      selectedFiles = selectedFiles.concat(files);
      updateImagePreview();
      this.value = ''; // Reset input
    });

    // Function to create content array for message
    async function createMessageContent(text, files) {
      const content = [];

      // Add text content if exists
      if (text.trim()) {
        content.push({
          type: "text",
          text: text.trim()
        });
      }

      // Add images if exist
      for (const file of files) {
        const base64Image = await fileToBase64(file);
        content.push({
          type: "image_url",
          image_url: {
            detail: "low",
            url: base64Image
          }
        });
      }

      return content;
    }

    // Function to create a new AI tool
    function createNewChat() {
      const chatName = prompt("Enter a name for the new AI tool:");
      if (chatName) {
        const newChat = {
          id: crypto.randomUUID(),
          name: chatName,
          messages: [],
          config: getCurrentConfig()
        };
        chatHistory.push(newChat);
        displayChatHistory();
        selectChat(newChat);
        saveChatHistoryToStorage(); // Save after creating new chat
      }
    }
    // Function to display chat history
    function displayChatHistory() {
      const chatHistoryDiv = document.querySelector('.chat-history');
      chatHistoryDiv.innerHTML = '';

      chatHistory.forEach((chat, index) => {
        const chatItem = document.createElement('li');
        chatItem.className = `select-chat nav-item d-flex justify-content-between ${chat.id === currentChat ? 'active' : ''}`;
        chatItem.dataset.index = index;
        chatItem.dataset.id = chat.id;
        chatItem.innerHTML = `
      <a style="width: 100%;" class="select-chat nav-link text-white" href="javascript:{}" data-index="${index}">
        <i class="fas fa-comment"></i> ${chat.name}
      </a>
      <a class="nav-link text-white" data-index="${index}" href="javascript:{}">
        <i class="delete-chat fas fa-trash-alt"></i>
      </a>
    `;
        chatHistoryDiv.appendChild(chatItem);
      });
    }

    // Function to create a chat message element
    function createChatMessageElement(role, content) {
      const chatBox = document.createElement('div');
      chatBox.className = `row ${role}-chat-box`;
      chatBox.id = `${role}-chat-box`;
      chatBox.style.display = 'flex';

      const chatIcon = document.createElement('div');
      chatIcon.className = 'chat-icon';
      const icon = document.createElement('img');
      icon.className = 'chatgpt-icon';
      icon.src = role === 'user' ? '/cdn/15/images/user-icon.png' : '/cdn/15/images/chatgpt-icon.png';
      chatIcon.appendChild(icon);

      const chatTxt = document.createElement('div');
      chatTxt.className = 'chat-txt';
      chatTxt.id = `${role}-message`;

      content.forEach(item => {
        if (item.type === "text") {
          const textDiv = document.createElement('div');
          textDiv.innerHTML = role === 'user' ? item.text : marked(item.text);
          chatTxt.appendChild(textDiv);
        } else if (item.type === "image_url") {
          const img = document.createElement('img');
          img.src = item.image_url.url;
          img.className = 'image-preview';
          chatTxt.appendChild(img);
        }
      });

      chatBox.appendChild(chatIcon);
      chatBox.appendChild(chatTxt);

      return chatBox;
    }

    // Function to select a chat
    function selectChat(chat) {
      document.getElementById('chat-content-area').innerHTML = `<div id="welcome-screen"
            class="h-100 flex-column align-items-center justify-content-center text-center p-4">
            <img src="https://cdn.jsdelivr.net/gh/platformaivn/web@1.0.68/dist/img/logo_icon.png" alt="Platform AI Logo"
              class="welcome-logo mb-4">
            <h2 class="text-light mb-2">Welcome to Platform AI</h2>
            <p>Start a conversation to begin</p>
          </div>`;
      currentChat = chat.id;
      selectedChat = chatHistory.find(chat => chat.id === currentChat);
      // Apply chat's configuration or default if none exists
      const config = chat.config || defaultConfig;
      applyConfig(config);

      chat.messages.forEach(message => {
        const messageElement = createChatMessageElement(message.role, message.content);
        document.getElementById('chat-content-area').appendChild(messageElement);
      });

      // Update active state in chat history
      document.querySelectorAll('.chat-history li').forEach(li => {
        li.classList.remove('active');
      });
      document.querySelector(`.chat-history li[data-id="${chat.id}"]`).classList.add('active');
    }

    // Function to update the output value
    function updateOutput(input) {
      const output = input.parentElement.nextElementSibling.querySelector('output');
      output.value = input.value;
    }

    // Add event listeners for range inputs
    document.querySelectorAll('input[type="range"]').forEach(input => {
      input.addEventListener('input', function () {
        updateOutput(this);
      });
    });

    // Function to get current parameter values
    function getParameterValues() {
      return {
        model: document.getElementById('gpt-model').value,
        temperature: parseFloat(document.getElementById('gpt-temperature').value),
        max_tokens: parseInt(document.getElementById('gpt-max-len').value),
        top_p: parseFloat(document.getElementById('gpt-topP').value),
        frequency_penalty: parseFloat(document.getElementById('gpt-frequency').value),
        presence_penalty: parseFloat(document.getElementById('gpt-precence').value),
        history_limit: parseInt(document.getElementById('gpt-history-limit').value)
      };
    }

    // Update handleApiCall function
    async function handleApiCall(userMessage) {
      if (!checkAuth()) {
        return;
      }

      const accessToken = getCookie('access_token');
      const params = getParameterValues();
      const systemPrompt = document.getElementById('system-prompt').value.trim();

      // Prepare messages array
      let messages = [];

      // Add system message if provided
      if (systemPrompt) {
        messages.push({
          role: 'system',
          content: [{
            type: "text",
            text: systemPrompt
          }]
        });
      }

      // Add previous messages
      messages = messages.concat(selectedChat.messages.slice(-params.history_limit));

      // Create content array for current message
      const currentMessageContent = await createMessageContent(userMessage, selectedFiles);

      const response = await fetch('https://api.platform.ai.vn/services/platform-ai-api/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${accessToken}`
        },
        body: JSON.stringify({
          model: params.model,
          messages: messages,
          temperature: params.temperature,
          max_tokens: params.max_tokens,
          top_p: params.top_p,
          frequency_penalty: params.frequency_penalty,
          presence_penalty: params.presence_penalty,
          stream: true
        })
      });
      if (response.status === 401) {
        showLoginModal();
        return;
      }
      // Clear selected files after sending
      selectedFiles = [];
      updateImagePreview();

      // Process response stream
      const reader = response.body.getReader();
      const decoder = new TextDecoder("utf-8");
      let gptMessage = '';
      const gptChatBox = createChatMessageElement('assistant', [{
        type: "text",
        text: "Thinking..."
      }]);
      document.getElementById('chat-content-area').appendChild(gptChatBox);
      gptChatBox.scrollIntoView({ behavior: 'smooth', block: 'end' });

      const chatContentArea = document.querySelector('.chat-content-area');
      const contentHeight = chatContentArea.scrollHeight;

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        const chunk = decoder.decode(value, { stream: true });
        const lines = chunk.split('\n').filter(line => line.startsWith('data: '));

        for (const line of lines) {
          const jsonData = line.replace('data: ', '');
          if (jsonData === '[DONE]\r') break;

          const parsedData = JSON.parse(jsonData);
          const content = parsedData.choices[0].delta.content;

          gptMessage += content;

          let endBlock = isOddCodeBlocks(gptMessage) ? "```" : "";
          gptChatBox.querySelector('.chat-txt').innerHTML = marked(gptMessage + endBlock);
          Prism.highlightAll();

          const currentScrollTop = chatContentArea.scrollTop;
          if (currentScrollTop + 800 >= contentHeight) {
            gptChatBox.scrollIntoView({ behavior: 'smooth', block: 'end' });
          }
        }
      }

      // Add assistant's response to chat history
      selectedChat.messages.push({
        role: 'assistant',
        content: [{
          type: "text",
          text: gptMessage
        }]
      });

      saveChatHistoryToStorage();
    }

    // Event listeners
    // Add event listeners for configuration changes
    function setupConfigChangeListeners() {
      const configElements = [
        'gpt-model',
        'gpt-temperature',
        'gpt-max-len',
        'gpt-topP',
        'gpt-frequency',
        'gpt-precence',
        'gpt-history-limit',
        'system-prompt'
      ];

      configElements.forEach(elementId => {
        document.getElementById(elementId).addEventListener('change', function () {
          if (currentChat && selectedChat) {
            selectedChat.config = getCurrentConfig();
          }
        });
      });

      // Also add listeners for range input events
      configElements.filter(id => document.getElementById(id).type === 'range')
        .forEach(elementId => {
          document.getElementById(elementId).addEventListener('input', function () {
            if (currentChat && selectedChat) {
              selectedChat.config = getCurrentConfig();
            }
          });
        });
    }

    // Call this function after the document is loaded
    document.addEventListener('DOMContentLoaded', setupConfigChangeListeners);
    document.querySelector('.chat-btn').addEventListener('click', createNewChat);

    document.getElementById('gpt-history-limit').addEventListener('input', function () {
      updateOutput(this);
    });

    // Modify the event listener for selecting a chat
    document.addEventListener('click', function (event) {
      if (event.target.classList.contains('select-chat')) {
        const index = event.target.getAttribute('data-index');
        selectChat(chatHistory[index]);
      }
      if (event.target.classList.contains('delete-chat')) {
        const index = event.target.getAttribute('data-index');
        chatHistory.splice(index, 1);
        displayChatHistory();
        if (chatHistory.length > 0) {
          selectChat(chatHistory[0]);
        } else {
          currentChat = "";
          document.getElementById('chat-content-area').innerHTML = '';
        }
        saveChatHistoryToStorage();
      }
    });

    document.addEventListener('click', function (event) {
      if (event.target.classList.contains('select-chat')) {
        const index = event.target.getAttribute('data-index');
        selectChat(chatHistory[index]);
      }
      if (event.target.classList.contains('delete-chat')) {
        const index = event.target.getAttribute('data-index');
        chatHistory.splice(index, 1);
        displayChatHistory();
      }
    });

    document.getElementById('send-button').addEventListener('click', async () => {
      const inputField = document.getElementById('chat-input');
      const userMessage = inputField.value.trim();

      if (userMessage === '' && selectedFiles.length === 0) return;

      if (currentChat === "") {
        createNewChat();
      }

      selectedChat = chatHistory.find(chat => chat.id === currentChat);

      // Create content array for the message
      const messageContent = await createMessageContent(userMessage, selectedFiles);

      // Create chat message element
      const userChatBox = createChatMessageElement('user', messageContent);
      document.getElementById('chat-content-area').appendChild(userChatBox);
      userChatBox.scrollIntoView({ behavior: 'smooth', block: 'end' });

      inputField.value = '';

      // Add message to chat history
      selectedChat.messages.push({
        role: 'user',
        content: messageContent
      });

      await handleApiCall(userMessage);
    });

    document.getElementById('chat-input').addEventListener('keydown', function (event) {
      if (!event.shiftKey && event.key === 'Enter') {
        event.preventDefault();
        document.getElementById('send-button').click();
      }
      if (event.shiftKey && event.key === 'Enter') {
        event.preventDefault();
        this.value += '\n';
      }
    });

    // Initialize output values
    document.querySelectorAll('input[type="range"]').forEach(updateOutput);

    document.addEventListener('DOMContentLoaded', function () {
      checkAuth(); // Check authentication on page load

      const loginButton = document.getElementById('loginButton');
      loginButton.addEventListener('click', async () => {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const errorDiv = document.getElementById('loginError');

        if (!username || !password) {
          errorDiv.textContent = 'Please enter both username and password';
          errorDiv.style.display = 'block';
          return;
        }

        const success = await login(username, password);
        if (!success) {
          errorDiv.textContent = 'Invalid username or password';
          errorDiv.style.display = 'block';
        }
      });

      // Close modal when clicking outside
      window.addEventListener('click', (event) => {
        const modal = document.getElementById('loginModal');
        if (event.target === modal) {
          hideLoginModal();
        }
      });
    });
    document.addEventListener('DOMContentLoaded', function () {
      // Remove existing modal click event listener
      const modal = document.getElementById('loginModal');
      modal.addEventListener('click', (event) => {
        // Prevent modal from closing when clicking outside
        event.stopPropagation();
      });

      const loginButton = document.getElementById('loginButton');
      loginButton.addEventListener('click', async () => {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const errorDiv = document.getElementById('loginError');

        if (!username || !password) {
          errorDiv.textContent = 'Please enter both username and password';
          errorDiv.style.display = 'block';
          return;
        }

        await login(username, password);
      });
    });

    // Add this to your existing JavaScript
    async function getUserInfo() {
      const accessToken = getCookie('access_token');
      if (!accessToken) return null;

      try {
        const response = await fetch('https://api.platform.ai.vn/services/platform-ai-api/account/info', {
          method: 'GET',
          headers: {
            'accept': 'application/json',
            'Authorization': `Bearer ${accessToken}`
          }
        });

        if (response.status === 401) {
          // Token is expired or invalid
          logout();
          return null;
        }

        if (!response.ok) {
          throw new Error('Failed to fetch user info');
        }

        const data = await response.json();
        return data;
      } catch (error) {
        console.error('Error fetching user info:', error);
        return null;
      }
    }

    async function updateUserInfoButton() {
      const userInfo = await getUserInfo();
      const userButton = document.getElementById('user-info-button');

      if (userInfo) {
        userButton.innerHTML = `
                <i class="fas fa-user"></i> ${userInfo.full_name || userInfo.username}
            `;
      } else {
        userButton.innerHTML = `
                <i class="fas fa-user"></i> Guest
            `;
      }
    }

    function logout() {
      // Remove the access token
      document.cookie = 'access_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';

      // Reset UI state
      const userButton = document.getElementById('user-info-button');
      userButton.innerHTML = '<i class="fas fa-user"></i> Guest';

      // Clear chat history
      chatHistory.length = 0;
      displayChatHistory();

      // Clear chat content area
      document.getElementById('chat-content-area').innerHTML = '';

      // clearChatHistoryStorage();

      // Show login modal
      showLoginModal();
    }

    // Add these function calls to your DOMContentLoaded event
    document.addEventListener('DOMContentLoaded', function () {
      // Existing DOMContentLoaded code remains...

      // Add user info update
      updateUserInfoButton();

      // Load saved chat history when page loads
      loadChatHistoryFromStorage();

      // Add event listener for config changes to save updated configs
      const configElements = [
        'gpt-model',
        'gpt-temperature',
        'gpt-max-len',
        'gpt-topP',
        'gpt-frequency',
        'gpt-precence',
        'gpt-history-limit',
        'system-prompt'
      ];

      configElements.forEach(elementId => {
        document.getElementById(elementId).addEventListener('change', function () {
          if (currentChat && selectedChat) {
            selectedChat.config = getCurrentConfig();
            saveChatHistoryToStorage(); // Save when config changes
          }
        });
      });

      document.getElementById('logout-button').addEventListener('click', function (event) {
        event.preventDefault();
        const confirmLogout = window.confirm('Are you sure you want to log out?');
        if (confirmLogout) {
          logout();
        }
      });

      // Update user info after successful login
      const existingLoginSuccess = login;
      login = async function (...args) {
        const success = await existingLoginSuccess.apply(this, args);
        if (success) {
          await updateUserInfoButton();
        }
        return success;
      };
    });

    const chatContentArea = document.getElementById('chat-content-area');
    // HÃ m kiá»m tra cÃ³ tin nháº¯n hay khÃ´ng
    function checkMessages() {
      const welcomeScreen = document.getElementById('welcome-screen');
      const hasMessages = chatContentArea.children.length > 1; // >1 vÃ¬ cÃ³ welcome screen
      if (hasMessages) {
        welcomeScreen.style.display = 'none';
      } else {
        welcomeScreen.style.display = 'flex';
      }
    }

    // Gá»i hÃ m kiá»m tra khi cÃ³ thay Äá»i trong chat
    const observer = new MutationObserver(checkMessages);
    observer.observe(chatContentArea, { childList: true });

    // Kiá»m tra láº§n Äáº§u khi táº£i trang
    checkMessages();
  </script>
</body>

</html>