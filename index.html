<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="Platform AI">
  <title>Platform GPT</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css" rel="stylesheet" />
  <link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/platformaivn/web@1.0.68/dist/img/logo_icon.png" type="image/x-icon" />
  <link rel="stylesheet" href="/cdn/15/css/style-v1.0.10.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.0/themes/prism.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/2.1.3/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.0/prism.min.js"></script>
</head>

<body>
  <!-- Header -->
  <header class="main-header">
    <div class="header-container">
      <div class="logo-container">
        <img src="https://cdn.jsdelivr.net/gh/platformaivn/web@1.0.68/dist/img/logo_icon.png" alt="Platform AI Logo"
          class="logo">
        <h1 class="brand-name">Platform AI</h1>
      </div>
      <div class="header-actions">
        <button id="user-info-button" class="header-button">
          <i class="fas fa-user"></i> Loading...
        </button>
        <button class="header-button">
          <i class="fas fa-cog"></i> Settings
        </button>
      </div>
    </div>
  </header>
  <!-- Main container -->
  <div class="container-fluid">
    <div class="row">
      <!-- Side navigation -->
      <div class="side-nav col-lg-3 col-md-12">
        <!-- New AI Tool button -->
        <div class="row p-2">
          <div class="chat-btn d-flex align-items-center">
            <span class="d-block">+ New AI Tool</span>
          </div>
        </div>

        <!-- Chat history -->
        <div class="row p-2">
          <ul class="list-unstyled">
            <div class="chat-history">
              <!-- Old chats will be displayed here -->
            </div>
          </ul>
        </div>

        <!-- Model selection and parameters -->
        <!-- START MODELS -->
        <div class="row p-2">
          <label for="gpt-model" class="form-label">Model</label>
          <select name="gpt-model" id="gpt-model" class="form-select text-light gpt-model">
            <option value="openai/gpt-4o-mini-2024-07-18:openrouter">gpt-4o-mini</option>
          </select>
        </div>


        <!-- START TEMPERATURE -->
        <div class="row p-2">
          <div class="col-12">
            <p class="form-label">Temperature</p>
          </div>
          <div class="col-10">
            <input type="range" class="form-range w-100" min="0" max="1" step="0.1" id="gpt-temperature"
              name="gpt-temperature" value="0" />
          </div>
          <div class="col-2 text-end">
            <output for="gpt-temperature">0</output>
          </div>
        </div>

        <!-- START MAXIMUM LENGTH -->
        <div class="row p-2">
          <div class="col-12">
            <p class="form-label">Maximum Length</p>
          </div>
          <div class="col-10">
            <input type="range" class="form-range w-100" min="0" max="16384" step="8" id="gpt-max-len"
              name="gpt-max-len" value="2048" />
          </div>
          <div class="col-2 text-end">
            <output for="gpt-max-len">2048</output>
          </div>
        </div>

        <!-- START TOP P -->
        <div class="row p-2">
          <div class="col-12">
            <p class="form-label">TopP</p>
          </div>
          <div class="col-10">
            <input type="range" class="form-range w-100" min="0" max="1" step="0.01" id="gpt-topP" name="gpt-topP"
              value="0.07" />
          </div>
          <div class="col-2 text-end">
            <output for="gpt-topP">0.07</output>
          </div>
        </div>

        <!-- START FREQUENCY PENALTY -->
        <div class="row p-2">
          <div class="col-12">
            <p class="form-label">Frequency Penalty</p>
          </div>
          <div class="col-10">
            <input type="range" class="form-range w-100" min="0" max="2" step="0.01" id="gpt-frequency"
              name="gpt-frequency" value="1" />
          </div>
          <div class="col-2 text-end">
            <output for="gpt-frequency">1</output>
          </div>
        </div>

        <!-- START PRESENCE PENALTY -->
        <div class="row p-2">
          <div class="col-12">
            <p class="form-label">Presence Penalty</p>
          </div>
          <div class="col-10">
            <input type="range" class="form-range w-100" min="0" max="2" step="0.01" id="gpt-precence"
              name="gpt-precence" value="0.5" />
          </div>
          <div class="col-2 text-end">
            <output for="gpt-precence">0.5</output>
          </div>
        </div>

        <!-- START HISTORY LIMIT -->
        <div class="row p-2">
          <div class="col-12">
            <p class="form-label">History Limit</p>
          </div>
          <div class="col-10">
            <input type="range" class="form-range w-100" min="1" max="50" step="1" id="gpt-history-limit"
              name="gpt-history-limit" value="10" />
          </div>
          <div class="col-2 text-end">
            <output for="gpt-history-limit">10</output>
          </div>
        </div>


        <!-- Add System Prompt textarea -->
        <div class="row p-2">
          <label for="system-prompt" class="form-label">System Prompt</label>
          <div class="col-12 system-prompt-inputs-container d-flex align-items-center">
            <textarea id="system-prompt" class="form-control" rows="8"
              placeholder="Enter system prompt here"></textarea>
          </div>
        </div>

        <hr />

        <!-- Settings, Help, and Logout links -->
        <div class="row">
          <div class="col-12">
            <ul class="list-unstyled">
              <li class="nav-item">
                <a class="nav-link text-white" href="#">
                  <i class="fas fa-cog"></i> Settings
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link text-white" href="#">
                  <i class="fas fa-question-circle"></i> Get Help
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link text-white" href="#" id="logout-button">
                  <i class="fas fa-sign-out-alt"></i> Log Out
                </a>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Chat content -->
      <div class="content p-0 pt-2 col-lg-9 col-md-12">
        <div class="chat-content-area" id="chat-content-area">
          <div id="welcome-screen" class="h-100 flex-column align-items-center justify-content-center text-center p-4">
            <img src="https://cdn.jsdelivr.net/gh/platformaivn/web@1.0.68/dist/img/logo_icon.png" alt="Platform AI Logo"
              class="welcome-logo mb-4">
            <h2 class="text-light mb-2">Welcome to Platform AI</h2>
            <p>Start a conversation to begin</p>
          </div>
        </div>

        <!-- Chat input area -->
        <div class="chat-input-area overflow-hidden">
          <div class="row">
            <div class="col-12 chat-inputs-area-inner">
              <div class="preview-container" id="image-preview-container"></div>
              <div class="row chat-inputs-container d-flex align-items-center">
                <textarea id="chat-input" class="col-10" placeholder="Send a message"></textarea>
                <span class="col-1">
                  <div class="upload-btn-wrapper">
                    <i class="fas fa-image" style="cursor: pointer;"></i>
                    <input type="file" style="width: 20px;" id="image-upload" accept="image/*" multiple />
                  </div>
                </span>
                <span class="col-1" id="send-button">
                  <i class="fa fa-paper-plane" aria-hidden="true" style="cursor: pointer;"></i>
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="d-flex align-items-center justify-content-center position-relative bottom-0">
    <div class="text-center">© 2024 Copyright Platform AI</div>
  </footer>
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Login to Platform AI</h2>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="username">Username:</label>
          <input type="text" id="username" class="form-control" placeholder="Enter username">
        </div>
        <div class="form-group">
          <label for="password">Password:</label>
          <input type="password" id="password" class="form-control" placeholder="Enter password">
        </div>
        <div id="loginError" class="alert alert-danger" style="display: none;"></div>
        <button id="loginButton" class="btn btn-primary">
          Login
          <div class="spinner"></div>
        </button>
      </div>
    </div>
  </div>
  <!-- External JS resources -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/material-ui/5.0.0-beta.5/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/cdn/15/js/authentication.js"></script>
  <script src="/cdn/15/js/chat-history-v1.0.1.js"></script>
  <script src="/cdn/15/js/chat-message.js"></script>
  <script src="/cdn/15/js/config.js"></script>
  <script src="/cdn/15/js/event-listeners.js"></script>
  <script src="/cdn/15/js/image-upload.js"></script>

  <script>
    let currentChat = "";
    let selectedChat;

    function showLoginModal() {
      const modal = document.getElementById('loginModal');
      modal.classList.add('force-show');
    }

    function hideLoginModal() {
      const modal = document.getElementById('loginModal');
      if (getCookie('access_token')) {
        loadChatHistoryFromStorage();
        modal.classList.remove('force-show');
      }
    }

    // Function to check if the number of code blocks is odd or even
    function isOddCodeBlocks(str) {
      return (str.split('```').length - 1) % 2 !== 0;
    }

    // Function to convert file to base64
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
      });
    }

    // Default configuration
    const defaultConfig = {
      model: "openai/gpt-4o-mini-2024-07-18:openrouter",
      temperature: 0,
      max_tokens: 2048,
      top_p: 0.07,
      frequency_penalty: 1,
      presence_penalty: 0.5,
      history_limit: 10,
      system_prompt: ""
    };

    // Add event listeners for range inputs
    document.querySelectorAll('input[type="range"]').forEach(input => {
      input.addEventListener('input', function () {
        updateOutput(this);
      });
    });

    // Function to get current parameter values
    function getParameterValues() {
      return {
        model: document.getElementById('gpt-model').value,
        temperature: parseFloat(document.getElementById('gpt-temperature').value),
        max_tokens: parseInt(document.getElementById('gpt-max-len').value),
        top_p: parseFloat(document.getElementById('gpt-topP').value),
        frequency_penalty: parseFloat(document.getElementById('gpt-frequency').value),
        presence_penalty: parseFloat(document.getElementById('gpt-precence').value),
        history_limit: parseInt(document.getElementById('gpt-history-limit').value)
      };
    }

    // Add event listeners for configuration changes
    function setupConfigChangeListeners() {
      const configElements = [
        'gpt-model',
        'gpt-temperature',
        'gpt-max-len',
        'gpt-topP',
        'gpt-frequency',
        'gpt-precence',
        'gpt-history-limit',
        'system-prompt'
      ];

      configElements.forEach(elementId => {
        document.getElementById(elementId).addEventListener('change', function () {
          if (currentChat && selectedChat) {
            selectedChat.config = getCurrentConfig();
          }
        });
      });

      // Also add listeners for range input events
      configElements.filter(id => document.getElementById(id).type === 'range')
        .forEach(elementId => {
          document.getElementById(elementId).addEventListener('input', function () {
            if (currentChat && selectedChat) {
              selectedChat.config = getCurrentConfig();
            }
          });
        });
    }

    // Call this function after the document is loaded
    document.addEventListener('DOMContentLoaded', setupConfigChangeListeners);
    document.querySelector('.chat-btn').addEventListener('click', createNewChat);

    document.getElementById('gpt-history-limit').addEventListener('input', function () {
      updateOutput(this);
    });

    // Modify the event listener for selecting a chat
    document.addEventListener('click', function (event) {
      if (event.target.classList.contains('select-chat')) {
        const index = event.target.getAttribute('data-index');
        selectChat(chatHistory[index]);
      }
      if (event.target.classList.contains('delete-chat')) {
        const index = event.target.getAttribute('data-index');
        chatHistory.splice(index, 1);
        displayChatHistory();
        if (chatHistory.length > 0) {
          selectChat(chatHistory[0]);
        } else {
          currentChat = "";
          document.getElementById('chat-content-area').innerHTML = '';
        }
        saveChatHistoryToStorage();
      }
    });

    document.addEventListener('click', function (event) {
      if (event.target.classList.contains('select-chat')) {
        const index = event.target.getAttribute('data-index');
        selectChat(chatHistory[index]);
      }
      if (event.target.classList.contains('delete-chat')) {
        const index = event.target.getAttribute('data-index');
        chatHistory.splice(index, 1);
        displayChatHistory();
      }
    });

    document.getElementById('send-button').addEventListener('click', async () => {
      const inputField = document.getElementById('chat-input');
      const userMessage = inputField.value.trim();

      if (userMessage === '' && selectedFiles.length === 0) return;

      if (currentChat === "") {
        createNewChat();
      }

      selectedChat = chatHistory.find(chat => chat.id === currentChat);

      // Create content array for the message
      const messageContent = await createMessageContent(userMessage, selectedFiles);

      // Create chat message element
      const userChatBox = createChatMessageElement('user', messageContent);
      document.getElementById('chat-content-area').appendChild(userChatBox);
      userChatBox.scrollIntoView({ behavior: 'smooth', block: 'end' });

      inputField.value = '';

      // Add message to chat history
      selectedChat.messages.push({
        role: 'user',
        content: messageContent
      });

      await handleApiCall(userMessage);
    });

    document.getElementById('chat-input').addEventListener('keydown', function (event) {
      if (!event.shiftKey && event.key === 'Enter') {
        event.preventDefault();
        document.getElementById('send-button').click();
      }
      if (event.shiftKey && event.key === 'Enter') {
        event.preventDefault();
        this.value += '\n';
      }
    });

    // Initialize output values
    document.querySelectorAll('input[type="range"]').forEach(updateOutput);

    const chatContentArea = document.getElementById('chat-content-area');
    // Hàm kiểm tra có tin nhắn hay không
    function checkMessages() {
      const welcomeScreen = document.getElementById('welcome-screen');
      const hasMessages = chatContentArea.children.length > 1; // >1 vì có welcome screen
      if (hasMessages) {
        welcomeScreen.style.display = 'none';
      } else {
        welcomeScreen.style.display = 'flex';
      }
    }

    // Gọi hàm kiểm tra khi có thay đổi trong chat
    const observer = new MutationObserver(checkMessages);
    observer.observe(chatContentArea, { childList: true });

    // Kiểm tra lần đầu khi tải trang
    checkMessages();
  </script>
</body>

</html>